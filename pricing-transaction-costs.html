<!DOCTYPE html>
<html lang="en-US"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Pricing Transaction Costs | Primitives</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Pricing Transaction Costs" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Gas Pricing Notes and Suggestions" />
<meta property="og:description" content="Gas Pricing Notes and Suggestions" />
<link rel="canonical" href="https://github.com/pages/manifoldfinance/primitives/pricing-transaction-costs" />
<meta property="og:url" content="https://github.com/pages/manifoldfinance/primitives/pricing-transaction-costs" />
<meta property="og:site_name" content="Primitives" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-09-28T00:00:00-07:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Pricing Transaction Costs" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-09-28T00:00:00-07:00","datePublished":"2022-09-28T00:00:00-07:00","description":"Gas Pricing Notes and Suggestions","headline":"Pricing Transaction Costs","mainEntityOfPage":{"@type":"WebPage","@id":"https://github.com/pages/manifoldfinance/primitives/pricing-transaction-costs"},"url":"https://github.com/pages/manifoldfinance/primitives/pricing-transaction-costs"}</script>
<!-- End Jekyll SEO tag -->
<link type="application/atom+xml" rel="alternate" href="https://github.com/pages/manifoldfinance/primitives/feed.xml" title="Primitives" /><!-- Emoji Favicon  -->
  <!-- Favicon -->
  <link
    rel="icon"
    href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéÑ</text></svg>"
  />
  <!-- <link rel="shortcut icon" href="/pages/manifoldfinance/primitives/favicon.ico"> -->

  <!-- Bootstrap CSS -->
  <link
    rel="stylesheet"
    href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css"
    integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu"
    crossorigin="anonymous"
  />

  <!-- Font Awesome -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css"
    integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog=="
    crossorigin="anonymous"
  />

  <!-- Custom CSS -->
  <link rel="stylesheet" href="/pages/manifoldfinance/primitives/assets/css/main.min.css" />
</head>
<body><!-- Navigation -->
<nav
  class="navbar navbar-default navbar-custom navbar-fixed-top invert"
>
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header page-scroll">
      <a class="navbar-brand" href="/pages/manifoldfinance/primitives/">Primitives</a>
      <button class="navbar-toggle" type="button">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div id="huxblog_navbar">
      <div class="navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          <li>
            <a href="/pages/manifoldfinance/primitives/">Home</a>
          </li><li>
            <a href="/pages/manifoldfinance/primitives/about">About</a>
          </li><li>
            <a href="/pages/manifoldfinance/primitives/archive">Archive</a>
          </li><li class="search-icon">
            <a href="javascript:void(0)">
              <i class="fas fa-search"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>
</nav>
<!-- Search -->
<div class="search-page">
  <div class="search-icon-close-container">
    <span class="search-icon-close">
      <i class="fas fa-chevron-down"></i>
    </span>
  </div>

  <div class="search-main container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <form>
          <input type="text" id="search-input" placeholder="$ grep..." />
        </form>
        <div id="search-results" class="mini-post-list"></div>
      </div>
    </div>
  </div>
</div>
<!-- Post Header --><header
  class="intro-header style-text"
>
  <div class="header-mask"></div><div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-heading">
          <div class="tags"></div>
          <h1>Pricing Transaction Costs</h1>
          <h2 class="subheading"></h2>
          <span class="meta"
            >Posted by manifoldfinance on September 28, 2022</span
          >
        </div>
      </div>
    </div>
  </div>
</header><!-- Post Content -->
<style>
  /* Place left on bigger screen */
  @media all and (min-width: 800px) {
    .anchorjs-link {
      position: absolute;
      left: -0.75em;
      font-size: 1.1em;
      margin-top: 0.1em;
    }
  }
</style>
<article>
  <div class="container">
    <div class="row">
      <!-- Post Container -->
      <div
        class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 post-container"
      ><h3 id="gas-pricing-notes-and-suggestions">Gas Pricing Notes and Suggestions</h3>

<p><img align="right" src="https://gist.githubusercontent.com/sambacha/9ec6a1a70466bcabe04eca3821e1c9d4/raw/1364229703b5f903e2852895cfae79845e5ddab9/app.svg" height="710" alt="" /></p>

<p>Carrying over from the issues we have:</p>

<ol>
  <li>DO NOT TRACK GAS USED VIA WRAPPER: gas used through a wrapper contract is not
accurate with Multicall due to EIP-2929</li>
</ol>

<blockquote>
  <p>This is probably the source of alot of issues TBH wrt gas price estimation.</p>
</blockquote>

<blockquote>
  <p>V3 = Trident V2 = SushiV1</p>
</blockquote>

<p>For each gas estimate, normalize decimals to that of the chosen <code class="language-plaintext highlighter-rouge">usd token</code>.</p>

<p>Use the BFS approach. It allows us to keep a reference to nodes that we want to
come back to, even though we haven‚Äôt checked/visited them yet. This is crucial
in both pathfinding and gas pricing, which is elaborated below.</p>

<ol>
  <li>First we seed BFS (breadth first search) queue with the best quotes for each
percentage. i.e. best quote when sending 10% of amount, best quote when
sending 20% of amount, ‚Ä¶]</li>
  <li>Then will explore the various combinations from each node.</li>
</ol>

<ul>
  <li>Size of the queue at this point is the number of potential routes we are
investigating for the given number of splits.</li>
  <li>If we didn‚Äôt improve our quote by adding another split, very unlikely to
improve it by splitting more after that.</li>
</ul>

<ol>
  <li>For all other percentages, add a new potential route.</li>
</ol>

<ul>
  <li>E.g. if our current aggregated route if missing 50%, we will create new nodes
and add to the queue for:</li>
  <li>50% + new 10% route, 50% + new 20% route, etc.</li>
</ul>

<ol>
  <li>[Calculate] if on L1, the estimated gas used based on hops and ticks across
all the routes if on L2, the gas used on the L2 based on hops and ticks
across all the routes</li>
  <li>If swapping on an L2 that includes a L1 security fee, calculate the fee and
include it in the gas adjusted quotes</li>
  <li>[check] ensure any addresses are aliased if needed for L2&gt;L1</li>
  <li>
    <p>[assert] Ensure the <code class="language-plaintext highlighter-rouge">gasModel</code> exists and that the swap route is a v3 only
route</p>
  </li>
  <li>Include a <code class="language-plaintext highlighter-rouge">networkCongestion</code> property when requesting EIP-1559-compatible
gas fee estimates. This value, which is a number from 0 to 1, where 0
represents ‚Äúnot congested‚Äù and 1 represents ‚Äúextremely congested‚Äù, can be
used to communicate the status of the overall network to the DApp and end
user.</li>
</ol>

<table>
  <thead>
    <tr>
      <th><strong>Field</strong></th>
      <th><strong>Value</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>networkCongestion</td>
      <td>A normalized number that can be used to gauge the congestion evel of the network with 0 meaning not congested and 1 meaning extremely congested</td>
    </tr>
    <tr>
      <td>minWaitTimeEstimate</td>
      <td>The fastest the transaction will take <in milliseconds=""></in></td>
    </tr>
    <tr>
      <td>maxWaitTimeEstimate</td>
      <td>The slowest the transaction will take <in milliseconds=""></in></td>
    </tr>
    <tr>
      <td>suggestedMaxPriorityFeePerGas</td>
      <td>‚ÄúA suggested tip‚Äù <GWEI hex="" numbe="">r"</GWEI></td>
    </tr>
    <tr>
      <td>suggestedMaxFeePerGas</td>
      <td>A suggested max fee the most a user will pay <GWEI hex="" number=""></GWEI></td>
    </tr>
  </tbody>
</table>

<h2 id="gwei-service">Gwei Service</h2>

<p>The Gwei Service is an important part of the overall system. Since Gwei pricing
is the most important portion of the overall system efficacy it is decoupled
from the application itself and run in a separate stack entirely. We inject the
Gwei pricing service by loading at runtime via <code class="language-plaintext highlighter-rouge">startGasWorker()</code>. <em>note</em> we use
the term GasWorker to draw a distinction between <code class="language-plaintext highlighter-rouge">gwei</code> and <code class="language-plaintext highlighter-rouge">gas</code>. Whereas
<code class="language-plaintext highlighter-rouge">gwei</code> is understood as a specific SI unit, gas is more abstract.</p>

<h2 id="gas-pricing-service">Gas Pricing Service</h2>

<p>For accurate pricing, we trim off the lowest price with the fastest time and
highest price with the slowest times until 80% of the data is represented; these
are outliers</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="cm">/** @dev filter transactions from blocks */</span>
<span class="nx">blocks</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">block</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
       <span class="nx">block</span><span class="p">.</span><span class="nx">transactions</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">tx</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
           <span class="kd">const</span> <span class="nx">price</span> <span class="o">=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">ethers</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="nx">formatUnits</span><span class="p">(</span><span class="nx">tx</span><span class="p">.</span><span class="nx">gasPrice</span><span class="p">,</span> <span class="dl">"</span><span class="s2">gwei</span><span class="dl">"</span><span class="p">));</span>
           <span class="kd">const</span> <span class="nx">duration</span> <span class="o">=</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">waitDuration</span><span class="p">;</span>
 <span class="cm">/**
 *
 *  Purge anything that takes over an hour
 */</span>
   <span class="k">if</span> <span class="p">(</span><span class="nx">duration</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">))</span> <span class="p">{</span> <span class="k">return</span><span class="p">;</span> <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="nx">duration</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="mi">60</span><span class="p">))</span> <span class="p">{</span>
               <span class="nx">data</span><span class="p">.</span><span class="nx">fast</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">price</span><span class="p">);</span>
       <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">duration</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="mi">60</span><span class="p">))</span> <span class="p">{</span>
               <span class="nx">data</span><span class="p">.</span><span class="nx">medium</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">price</span><span class="p">);</span>
       <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
               <span class="nx">data</span><span class="p">.</span><span class="nx">slow</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">price</span><span class="p">);</span>
       <span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="transaction-details">Transaction Details</h3>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="cm">/**
 * Add the transaction details
 *  @const delta
 *  @param waitDuration
 *  @param dataLength
 *  @param gasLimit
 *  @param value
 */</span>
<span class="kd">const</span> <span class="nx">delta</span> <span class="o">=</span> <span class="nx">timestamp</span> <span class="o">-</span> <span class="nx">seenTime</span><span class="p">;</span>
<span class="nx">txs</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
  <span class="na">w</span><span class="p">:</span> <span class="nx">delta</span><span class="p">,</span> <span class="c1">// waitDuration</span>
  <span class="na">d</span><span class="p">:</span> <span class="nx">ethers</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="nx">hexDataLength</span><span class="p">(</span><span class="nx">tx</span><span class="p">.</span><span class="nx">data</span><span class="p">),</span> <span class="c1">// dataLength</span>
  <span class="na">l</span><span class="p">:</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">gasLimit</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span> <span class="c1">// gasLimit</span>
  <span class="na">p</span><span class="p">:</span> <span class="nx">ethers</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="nx">formatUnits</span><span class="p">(</span><span class="nx">tx</span><span class="p">.</span><span class="nx">gasPrice</span><span class="p">,</span> <span class="dl">'</span><span class="s1">gwei</span><span class="dl">'</span><span class="p">),</span> <span class="c1">// gasPrice</span>
  <span class="na">v</span><span class="p">:</span> <span class="nx">ethers</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="nx">formatUnits</span><span class="p">(</span><span class="nx">tx</span><span class="p">.</span><span class="nx">value</span><span class="p">),</span> <span class="c1">// value</span>
<span class="p">});</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="canary-scanning">Canary Scanning</h3>

<blockquote>
  <p>Failsafe guard</p>
</blockquote>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="c1">// Canary scanning (check every second)</span>
<span class="c1">// If we go too long without a ne block or a new transaction, it indicates the</span>
<span class="c1">// underlying connection to a backend has probalby disconnected. By exiting,</span>
<span class="c1">// we give our process manager a change to run us again to reconnect</span>
<span class="nx">setInterval</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">delta</span> <span class="o">=</span> <span class="nx">getTime</span><span class="p">()</span> <span class="o">-</span> <span class="nx">canaryTimer</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">delta</span> <span class="o">&gt;</span> <span class="nx">MAX_DISCONNECT</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Canary: forcing restart...`</span><span class="p">);</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">},</span> <span class="mi">1000</span><span class="p">).</span><span class="nx">unref</span><span class="p">();</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>How to subscribe to gas price changes</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="k">import</span> <span class="p">{</span> <span class="nx">Container</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">typedi</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">EventConstants</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@constants/events</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">EventEmitter</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">events</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="p">{</span> <span class="nx">GAS_CHANGE</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">EventConstants</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">events</span><span class="p">:</span> <span class="nx">EventEmitter</span> <span class="o">=</span> <span class="nx">Container</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">eventEmitter</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">events</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">GAS_CHANGE</span><span class="p">,</span> <span class="p">(</span><span class="nx">newGasPrice</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// do something with the newGasPrice</span>
<span class="p">});</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="reference-interface-from-metamask">Reference Interface from MetaMask</h3>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="c1">// source: https://github.com/MetaMask/controllers/commit/77b1410a0611bbea785e5528b44143aebe5d407f</span>
<span class="cm">/**
 * @type Eip1559GasFee
 *
 * Data necessary to provide an estimate of a gas fee with a specific tip
 * @property minWaitTimeEstimate - The fastest the transaction will take, in milliseconds
 * @property maxWaitTimeEstimate - The slowest the transaction will take, in milliseconds
 * @property suggestedMaxPriorityFeePerGas - A suggested "tip", a GWEI hex number
 * @property suggestedMaxFeePerGas - A suggested max fee, the most a user will pay. a GWEI hex number
 */</span>
<span class="k">export</span> <span class="kd">type</span> <span class="nx">Eip1559GasFee</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">minWaitTimeEstimate</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span> <span class="c1">// a time duration in milliseconds</span>
  <span class="nl">maxWaitTimeEstimate</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span> <span class="c1">// a time duration in milliseconds</span>
  <span class="nl">suggestedMaxPriorityFeePerGas</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span> <span class="c1">// a GWEI decimal number</span>
  <span class="nl">suggestedMaxFeePerGas</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span> <span class="c1">// a GWEI decimal number</span>
<span class="p">};</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="cm">/**
 * @type GasFeeEstimates
 *
 * Data necessary to provide multiple GasFee estimates, and supporting information, to the user
 * @property low - A GasFee for a minimum necessary combination of tip and maxFee
 * @property medium - A GasFee for a recommended combination of tip and maxFee
 * @property high - A GasFee for a high combination of tip and maxFee
 * @property estimatedBaseFee - An estimate of what the base fee will be for the pending/next block. A GWEI dec number
 * @property networkCongestion - A normalized number that can be used to gauge the congestion
 * level of the network, with 0 meaning not congested and 1 meaning extremely congested
 */</span>

<span class="k">export</span> <span class="kd">type</span> <span class="nx">GasFeeEstimates</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">low</span><span class="p">:</span> <span class="nx">Eip1559GasFee</span><span class="p">;</span>
  <span class="nl">medium</span><span class="p">:</span> <span class="nx">Eip1559GasFee</span><span class="p">;</span>
  <span class="nl">high</span><span class="p">:</span> <span class="nx">Eip1559GasFee</span><span class="p">;</span>
  <span class="nl">estimatedBaseFee</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nl">networkCongestion</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>
<span class="p">};</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre><span class="cm">/**
 * Calculates the approximate normalized ranking of the latest base fee in the given blocks among
 * the entirety of the blocks. That is, sorts all of the base fees, then finds the rank of the first
 * base fee that meets or exceeds the latest base fee among the base fees. The result is the rank
 * normalized as a number between 0 and 1, where 0 means that the latest base fee is the least of
 * all and 1 means that the latest base fee is the greatest of all. This can ultimately be used to
 * render a visualization of the status of the network for users.
 *
 * @param blocks - A set of blocks as obtained from {@link fetchBlockFeeHistory}.
 * @returns A promise of a number between 0 and 1.
 */</span>
<span class="k">async</span> <span class="kd">function</span> <span class="nx">calculateNetworkCongestionLevelFrom</span><span class="p">(</span>
  <span class="nx">blocks</span><span class="p">:</span> <span class="nx">Block</span><span class="o">&lt;</span><span class="nx">Percentile</span><span class="o">&gt;</span><span class="p">[],</span>
<span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="kr">number</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">latestBaseFeePerGas</span> <span class="o">=</span> <span class="nx">blocks</span><span class="p">[</span><span class="nx">blocks</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="nx">baseFeePerGas</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">sortedBaseFeesPerGas</span> <span class="o">=</span> <span class="nx">blocks</span>
    <span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">block</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">block</span><span class="p">.</span><span class="nx">baseFeePerGas</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">sort</span><span class="p">((</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">cmp</span><span class="p">(</span><span class="nx">b</span><span class="p">));</span>
  <span class="kd">const</span> <span class="nx">indexOfBaseFeeNearestToLatest</span> <span class="o">=</span> <span class="nx">sortedBaseFeesPerGas</span><span class="p">.</span><span class="nx">findIndex</span><span class="p">(</span>
    <span class="p">(</span><span class="nx">baseFeePerGas</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">baseFeePerGas</span><span class="p">.</span><span class="nx">gte</span><span class="p">(</span><span class="nx">latestBaseFeePerGas</span><span class="p">),</span>
  <span class="p">);</span>
  <span class="k">return</span> <span class="nx">indexOfBaseFeeNearestToLatest</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span>
    <span class="p">?</span> <span class="nx">indexOfBaseFeeNearestToLatest</span> <span class="o">/</span> <span class="p">(</span><span class="nx">blocks</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"low"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"minWaitTimeEstimate"</span><span class="p">:</span><span class="w"> </span><span class="mi">180000</span><span class="p">,</span><span class="w">
    </span><span class="nl">"maxWaitTimeEstimate"</span><span class="p">:</span><span class="w"> </span><span class="mi">360000</span><span class="p">,</span><span class="w">
    </span><span class="nl">"suggestedMaxPriorityFeePerGas"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"suggestedMaxFeePerGas"</span><span class="p">:</span><span class="w"> </span><span class="s2">"40"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"medium"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"minWaitTimeEstimate"</span><span class="p">:</span><span class="w"> </span><span class="mi">15000</span><span class="p">,</span><span class="w">
    </span><span class="nl">"maxWaitTimeEstimate"</span><span class="p">:</span><span class="w"> </span><span class="mi">60000</span><span class="p">,</span><span class="w">
    </span><span class="nl">"suggestedMaxPriorityFeePerGas"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"suggestedMaxFeePerGas"</span><span class="p">:</span><span class="w"> </span><span class="s2">"45"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"high"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"minWaitTimeEstimate"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
    </span><span class="nl">"maxWaitTimeEstimate"</span><span class="p">:</span><span class="w"> </span><span class="mi">15000</span><span class="p">,</span><span class="w">
    </span><span class="nl">"suggestedMaxPriorityFeePerGas"</span><span class="p">:</span><span class="w"> </span><span class="s2">"3"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"suggestedMaxFeePerGas"</span><span class="p">:</span><span class="w"> </span><span class="s2">"65"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"estimatedBaseFee"</span><span class="p">:</span><span class="w"> </span><span class="s2">"32"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"networkCongestion"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.2</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>


        <!-- Post Pager -->
        <div>
          <hr style="visibility: hidden" />
          <ul class="pager"><li class="previous">
              <a
                href="/pages/manifoldfinance/primitives/the-allowchain"
                data-toggle="tooltip"
                data-placement="top"
                title="The Allowchain"
              >
                Previous<br />
                <span>The Allowchain</span>
              </a>
            </li><li class="next">
              <a
                href="/pages/manifoldfinance/primitives/questions-for-new-tech"
                data-toggle="tooltip"
                data-placement="top"
                title="Questions For New Tech"
              >
                Next<br />
                <span>Questions For New Tech</span>
              </a>
            </li></ul>
          <hr style="visibility: hidden" />
        </div></div><!-- Side Catalog Container -->
      <div
        class="col-lg-2 col-lg-offset-0 visible-lg-block sidebar-container catalog-container"
      >
        <div class="side-catalog">
          <hr class="hidden-sm hidden-xs" />
          <h5>
            <a class="catalog-toggle" href="#">CATALOG</a>
          </h5>
          <ul class="catalog-body"></ul>
        </div>
      </div><!-- Sidebar Container -->
      <div
        class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 sidebar-container"
      ><!-- Featured Tags -->
<section><hr class="hidden-sm hidden-xs"><h5>
        <a href="/pages/manifoldfinance/primitives/archive/">FEATURED TAGS</a>
    </h5>
    <div class="tags"><a data-sort="0014"
            href="/pages/manifoldfinance/primitives/archive/?tag=distributed+computing"
            title="distributed computing"
            rel="3">distributed computing</a><a data-sort="0014"
            href="/pages/manifoldfinance/primitives/archive/?tag=ethereum"
            title="ethereum"
            rel="3">ethereum</a><a data-sort="0015"
            href="/pages/manifoldfinance/primitives/archive/?tag=blockchain"
            title="blockchain"
            rel="2">blockchain</a><a data-sort="0016"
            href="/pages/manifoldfinance/primitives/archive/?tag=DAO"
            title="DAO"
            rel="1">DAO</a><a data-sort="0016"
            href="/pages/manifoldfinance/primitives/archive/?tag=Jekyll"
            title="Jekyll"
            rel="1">Jekyll</a><a data-sort="0016"
            href="/pages/manifoldfinance/primitives/archive/?tag=Markdown"
            title="Markdown"
            rel="1">Markdown</a><a data-sort="0016"
            href="/pages/manifoldfinance/primitives/archive/?tag=amm"
            title="amm"
            rel="1">amm</a><a data-sort="0016"
            href="/pages/manifoldfinance/primitives/archive/?tag=analysis"
            title="analysis"
            rel="1">analysis</a><a data-sort="0016"
            href="/pages/manifoldfinance/primitives/archive/?tag=client+development"
            title="client development"
            rel="1">client development</a><a data-sort="0016"
            href="/pages/manifoldfinance/primitives/archive/?tag=dao"
            title="dao"
            rel="1">dao</a><a data-sort="0016"
            href="/pages/manifoldfinance/primitives/archive/?tag=devops"
            title="devops"
            rel="1">devops</a><a data-sort="0016"
            href="/pages/manifoldfinance/primitives/archive/?tag=gitops"
            title="gitops"
            rel="1">gitops</a><a data-sort="0016"
            href="/pages/manifoldfinance/primitives/archive/?tag=governance"
            title="governance"
            rel="1">governance</a><a data-sort="0016"
            href="/pages/manifoldfinance/primitives/archive/?tag=json+rpc"
            title="json rpc"
            rel="1">json rpc</a><a data-sort="0016"
            href="/pages/manifoldfinance/primitives/archive/?tag=nix"
            title="nix"
            rel="1">nix</a><a data-sort="0016"
            href="/pages/manifoldfinance/primitives/archive/?tag=protocol"
            title="protocol"
            rel="1">protocol</a><a data-sort="0016"
            href="/pages/manifoldfinance/primitives/archive/?tag=routing"
            title="routing"
            rel="1">routing</a><a data-sort="0016"
            href="/pages/manifoldfinance/primitives/archive/?tag=sushiswap"
            title="sushiswap"
            rel="1">sushiswap</a><a data-sort="0016"
            href="/pages/manifoldfinance/primitives/archive/?tag=tooling"
            title="tooling"
            rel="1">tooling</a><a data-sort="0016"
            href="/pages/manifoldfinance/primitives/archive/?tag=trading"
            title="trading"
            rel="1">trading</a>
    </div>
</section>
</div>
    </div>
  </div>
</article>
<!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><!-- SNS -->
<ul class="list-inline text-center">
  
  <li>
    <a href="/pages/manifoldfinance/primitives/feed.xml">
      <span class="fa-stack fa-lg">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  </li><li>
    <a target="_blank" href="mailto:sam@manifoldfinance.com">
      <span class="fa-stack fa-lg">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  </li><li>
    <a target="_blank" href="https://github.com/manifoldfinance">
      <span class="fa-stack fa-lg">
        <i class="fas fa-circle fa-stack-2x fa-inverse"></i>
        <i class="fab fa-github fa-stack-2x"></i>
      </span>
    </a>
  </li><li>
    <a href="https://twitter.com/foldfinance">
      <span class="fa-stack fa-lg">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  </li></ul>
<p class="copyright text-muted">See
          <a href="https://github.com/sambacha"></a> @sambacha | &copy; 2022-2024 manifoldfinance
        </p>
      </div>
    </div>
  </div>
</footer>

<!-- jQuery -->
<script
  src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"
  integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg=="
  crossorigin="anonymous"
></script>

<!-- Bootstrap JavaScript-->
<!-- Currently, only navbar scroll-down effect at desktop still depends on this -->
<script
  src="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"
  integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd"
  crossorigin="anonymous"
></script>

<!-- Simple Jekyll Search -->
<script
  src="https://cdnjs.cloudflare.com/ajax/libs/simple-jekyll-search/1.7.12/simple-jekyll-search.min.js"
  integrity="sha512-APy7Ff/y4pdIHleqiTMcRZ8Wu6tjfqhJpgAcaCvTuFQPj/G+/A5u0uZi/DkfkuLQ6FeFmDJgh/zl0y3If/VUyA=="
  crossorigin="anonymous"
></script>

<!-- MathJax https://github.com/mathjax/MathJax/issues/2220 -->
<script>
  MathJax = {
    options: {
      renderActions: {
        /* add a new named action not to override the original 'find' action */
        find_script_mathtex: [
          10,
          function (doc) {
            for (const node of document.querySelectorAll(
              'script[type^="math/tex"]',
            )) {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(
                node.textContent,
                doc.inputJax[0],
                display,
              );
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = { node: text, delim: '', n: 0 };
              math.end = { node: text, delim: '', n: 0 };
              doc.math.push(math);
            }
          },
          '',
        ],
      },
    },
  };
</script>
<script
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.0.5/es5/tex-chtml.js"
  integrity="sha512-WIPUeuVusAT6dUtN6xKArYCBEa76ltyvaz3ltvQd+dy7ISdGJv1Y3y7eDBEF986YfNtmZGLdAaEBSgeBb+8OSg=="
  crossorigin="anonymous"
></script>

<!-- Async load function -->
<script>
  function async(u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener(
        'load',
        function (e) {
          c(null, e);
        },
        false,
      );
    }
    s.parentNode.insertBefore(o, s);
  }
</script><!-- AnchorJS -->
<script>
  async(
    'https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.2/anchor.min.js',
    function () {
      anchors.options = {
        visible: 'hover',
      };
      anchors
        .add()
        .remove('.intro-header h1')
        .remove('.subheading')
        .remove('.sidebar-container h5');
    },
  );
</script><!-- Custom JavaScript -->
<script src="/pages/manifoldfinance/primitives/assets/js/main.js"></script><!-- Side Catalog -->
<script src="/pages/manifoldfinance/primitives/assets/js/catalog.js"></script></body>
</html>
