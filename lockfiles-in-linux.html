<!DOCTYPE html>
<html lang="en-US"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>File locking in Linux | Primitives</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="File locking in Linux" />
<meta name="author" content="Victor Gaydov" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="File locking in Linux" />
<meta property="og:description" content="File locking in Linux" />
<link rel="canonical" href="https://github.com/pages/manifoldfinance/primitives/lockfiles-in-linux" />
<meta property="og:url" content="https://github.com/pages/manifoldfinance/primitives/lockfiles-in-linux" />
<meta property="og:site_name" content="Primitives" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-10-05T00:00:00-07:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="File locking in Linux" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Victor Gaydov"},"dateModified":"2022-10-05T00:00:00-07:00","datePublished":"2022-10-05T00:00:00-07:00","description":"File locking in Linux","headline":"File locking in Linux","mainEntityOfPage":{"@type":"WebPage","@id":"https://github.com/pages/manifoldfinance/primitives/lockfiles-in-linux"},"url":"https://github.com/pages/manifoldfinance/primitives/lockfiles-in-linux"}</script>
<!-- End Jekyll SEO tag -->
<link type="application/atom+xml" rel="alternate" href="https://github.com/pages/manifoldfinance/primitives/feed.xml" title="Primitives" /><!-- Emoji Favicon  -->
  <!-- Favicon -->
  <link
    rel="icon"
    href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🎄</text></svg>"
  />
  <!-- <link rel="shortcut icon" href="/pages/manifoldfinance/primitives/favicon.ico"> -->

  <!-- Bootstrap CSS -->
  <link
    rel="stylesheet"
    href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css"
    integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu"
    crossorigin="anonymous"
  />

  <!-- Font Awesome -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css"
    integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog=="
    crossorigin="anonymous"
  />

  <!-- Custom CSS -->
  <link rel="stylesheet" href="/pages/manifoldfinance/primitives/assets/css/main.min.css" />
</head>
<body><!-- Navigation -->
<nav
  class="navbar navbar-default navbar-custom navbar-fixed-top invert"
>
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header page-scroll">
      <a class="navbar-brand" href="/pages/manifoldfinance/primitives/">Primitives</a>
      <button class="navbar-toggle" type="button">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div id="huxblog_navbar">
      <div class="navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          <li>
            <a href="/pages/manifoldfinance/primitives/">Home</a>
          </li><li>
            <a href="/pages/manifoldfinance/primitives/about">About</a>
          </li><li>
            <a href="/pages/manifoldfinance/primitives/archive">Archive</a>
          </li><li class="search-icon">
            <a href="javascript:void(0)">
              <i class="fas fa-search"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>
</nav>
<!-- Search -->
<div class="search-page">
  <div class="search-icon-close-container">
    <span class="search-icon-close">
      <i class="fas fa-chevron-down"></i>
    </span>
  </div>

  <div class="search-main container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <form>
          <input type="text" id="search-input" placeholder="$ grep..." />
        </form>
        <div id="search-results" class="mini-post-list"></div>
      </div>
    </div>
  </div>
</div>
<!-- Post Header --><header
  class="intro-header style-text"
>
  <div class="header-mask"></div><div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-heading">
          <div class="tags"></div>
          <h1>File locking in Linux</h1>
          <h2 class="subheading"></h2>
          <span class="meta"
            >Posted by Victor Gaydov on October 5, 2022</span
          >
        </div>
      </div>
    </div>
  </div>
</header><!-- Post Content -->
<style>
  /* Place left on bigger screen */
  @media all and (min-width: 800px) {
    .anchorjs-link {
      position: absolute;
      left: -0.75em;
      font-size: 1.1em;
      margin-top: 0.1em;
    }
  }
</style>
<article>
  <div class="container">
    <div class="row">
      <!-- Post Container -->
      <div
        class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 post-container"
      ><h1 id="file-locking-in-linux">File locking in Linux</h1>

<blockquote>
  <p>Introduction Advisory locking Common features Differing features File
descriptors and i-nodes BSD locks (flock) POSIX record locks (fcntl) lockf
function Open file description locks (fcntl) Emulating Open file description
locks Test program Command-line tools Mandatory locking Example usage
Introduction File locking is a mutual-exclusion mechanism for files. Linux
supports two major kinds of file locks: advisory locks mandatory locks Below
we discuss all lock types available in POSIX and Linux and provide usage
examples.</p>
</blockquote>

<p><strong>Table of contents</strong></p>

<ul>
  <li><a href="https://gavv.net/articles/file-locks/#introduction">Introduction</a></li>
  <li><a href="https://gavv.net/articles/file-locks/#advisory-locking">Advisory locking</a></li>
  <li><a href="https://gavv.net/articles/file-locks/#common-features">Common features</a></li>
  <li><a href="https://gavv.net/articles/file-locks/#differing-features">Differing features</a></li>
  <li><a href="https://gavv.net/articles/file-locks/#file-descriptors-and-i-nodes">File descriptors and i-nodes</a></li>
  <li><a href="https://gavv.net/articles/file-locks/#bsd-locks-flock">BSD locks (flock)</a></li>
  <li><a href="https://gavv.net/articles/file-locks/#posix-record-locks-fcntl">POSIX record locks (fcntl)</a></li>
  <li><a href="https://gavv.net/articles/file-locks/#lockf-function">lockf function</a></li>
  <li><a href="https://gavv.net/articles/file-locks/#open-file-description-locks-fcntl">Open file description locks (fcntl)</a></li>
  <li><a href="https://gavv.net/articles/file-locks/#emulating-open-file-description-locks">Emulating Open file description locks</a></li>
  <li><a href="https://gavv.net/articles/file-locks/#test-program">Test program</a></li>
  <li><a href="https://gavv.net/articles/file-locks/#command-line-tools">Command-line tools</a></li>
  <li><a href="https://gavv.net/articles/file-locks/#mandatory-locking">Mandatory locking</a></li>
  <li><a href="https://gavv.net/articles/file-locks/#example-usage">Example usage</a></li>
</ul>

<hr />

<h2 id="introduction"><a href="https://gavv.net/articles/file-locks/#introduction"></a>Introduction</h2>

<p><a href="https://en.wikipedia.org/wiki/File_locking">File locking</a> is a mutual-exclusion
mechanism for files. Linux supports two major kinds of file locks:</p>

<ul>
  <li>advisory locks</li>
  <li>mandatory locks</li>
</ul>

<p>Below we discuss all lock types available in POSIX and Linux and provide usage
examples.</p>

<hr />

<h2 id="advisory-locking"><a href="https://gavv.net/articles/file-locks/#advisory-locking"></a>Advisory locking</h2>

<p>Traditionally, locks are
<a href="https://unix.stackexchange.com/questions/147392/what-is-advisory-locking-on-files-that-unix-systems-typically-employs">advisory</a>
in Unix. They work only when a process explicitly acquires and releases locks,
and are ignored if a process is not aware of locks.</p>

<p>There are several types of advisory locks available in Linux:</p>

<ul>
  <li>BSD locks (flock)</li>
  <li>POSIX record locks (fcntl, lockf)</li>
  <li>Open file description locks (fcntl)</li>
</ul>

<p>All locks except the <code class="language-plaintext highlighter-rouge">lockf</code> function are
<a href="https://en.wikipedia.org/wiki/Readers%E2%80%93writer_lock">reader-writer locks</a>,
i.e. support exclusive and shared modes.</p>

<p>Note that <a href="http://man7.org/linux/man-pages/man3/flockfile.3.html"><code class="language-plaintext highlighter-rouge">flockfile</code></a>
and friends have nothing to do with the file locks. They manage internal mutex
of the <code class="language-plaintext highlighter-rouge">FILE</code> object from stdio.</p>

<p>Reference:</p>

<ul>
  <li><a href="https://www.gnu.org/software/libc/manual/html_node/File-Locks.html">File Locks</a>,
GNU libc manual</li>
  <li><a href="https://www.gnu.org/software/libc/manual/html_node/Open-File-Description-Locks.html">Open File Description Locks</a>,
GNU libc manual</li>
  <li><a href="https://lwn.net/Articles/586904/">File-private POSIX locks</a>, an LWN article
about the predecessor of open file description locks</li>
</ul>

<h3 id="common-features"><a href="https://gavv.net/articles/file-locks/#common-features"></a>Common features</h3>

<p>The following features are common for locks of all types:</p>

<ul>
  <li>All locks support blocking and non-blocking operations.</li>
  <li>Locks are allowed only on files, but not directories.</li>
  <li>Locks are automatically removed when the process exits or terminates. It’s
guaranteed that if a lock is acquired, the process acquiring the lock is still
alive.</li>
</ul>

<h3 id="differing-features"><a href="https://gavv.net/articles/file-locks/#differing-features"></a>Differing features</h3>

<p>This table summarizes the difference between the lock types. A more detailed
description and usage examples are provided below.</p>

<table>
  <thead>
    <tr>
      <th> </th>
      <th>BSD locks</th>
      <th>lockf function</th>
      <th>POSIX record locks</th>
      <th>Open file description locks</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Portability</td>
      <td>widely available</td>
      <td>POSIX (XSI)</td>
      <td>POSIX (base standard)</td>
      <td>Linux 3.15+</td>
    </tr>
    <tr>
      <td>Associated with</td>
      <td>File object</td>
      <td>[i-node, pid] pair</td>
      <td>[i-node, pid] pair</td>
      <td>File object</td>
    </tr>
    <tr>
      <td>Applying to byte range</td>
      <td>no</td>
      <td>yes</td>
      <td>yes</td>
      <td>yes</td>
    </tr>
    <tr>
      <td>Support exclusive and shared modes</td>
      <td>yes</td>
      <td>no</td>
      <td>yes</td>
      <td>yes</td>
    </tr>
    <tr>
      <td>Atomic mode switch</td>
      <td>no</td>
      <td>-</td>
      <td>yes</td>
      <td>yes</td>
    </tr>
    <tr>
      <td>Works on NFS (Linux)</td>
      <td>Linux 2.6.12+</td>
      <td>yes</td>
      <td>yes</td>
      <td>yes</td>
    </tr>
  </tbody>
</table>

<h3 id="file-descriptors-and-i-nodes"><a href="https://gavv.net/articles/file-locks/#file-descriptors-and-i-nodes"></a>File descriptors and i-nodes</h3>

<p>A <a href="https://en.wikipedia.org/wiki/File_descriptor"><em>file descriptor</em></a> is an index
in the per-process file descriptor table (in the left of the picture). Each file
descriptor table entry contains a reference to a <em>file object</em>, stored in the
file table (in the middle of the picture). Each file object contains a reference
to an <a href="https://en.wikipedia.org/wiki/Inode">i-node</a>, stored in the i-node table
(in the right of the picture).</p>

<p><img src="https://gavv.net/articles/file-locks/tables.png" alt="" /></p>

<p>A file descriptor is just a number that is used to refer a file object from the
user space. A file object represents an opened file. It contains things likes
current read/write offset, non-blocking flag and another non-persistent state.
An i-node represents a filesystem object. It contains things like file
meta-information (e.g. owner and permissions) and references to data blocks.</p>

<p>File descriptors created by several <code class="language-plaintext highlighter-rouge">open()</code> calls for the same file path point
to different file objects, but these file objects point to the same i-node.
Duplicated file descriptors created by <code class="language-plaintext highlighter-rouge">dup2()</code> or <code class="language-plaintext highlighter-rouge">fork()</code> point to the same
file object.</p>

<p>A BSD lock and an Open file description lock is associated with a file object,
while a POSIX record lock is associated with an <code class="language-plaintext highlighter-rouge">[i-node, pid]</code> pair. We’ll
discuss it below.</p>

<h3 id="bsd-locks-flock"><a href="https://gavv.net/articles/file-locks/#bsd-locks-flock"></a>BSD locks (flock)</h3>

<p>The simplest and most common file locks are provided by
<a href="http://man7.org/linux/man-pages/man2/flock.2.html"><code class="language-plaintext highlighter-rouge">flock(2)</code></a>.</p>

<p>Features:</p>

<ul>
  <li>not specified in POSIX, but widely available on various Unix systems</li>
  <li>always lock the entire file</li>
  <li>associated with a file object</li>
  <li>do not guarantee atomic switch between the locking modes (exclusive and
shared)</li>
  <li>up to Linux 2.6.11, didn’t work on NFS; since Linux 2.6.12, flock() locks on
NFS are emulated using fcntl() POSIX record byte-range locks on the entire
file (unless the emulation is disabled in the NFS mount options)</li>
</ul>

<p>The lock acquisition is associated with a file object, i.e.:</p>

<ul>
  <li>duplicated file descriptors, e.g. created using <code class="language-plaintext highlighter-rouge">dup2</code> or <code class="language-plaintext highlighter-rouge">fork</code>, share the
lock acquisition;</li>
  <li>independent file descriptors, e.g. created using two <code class="language-plaintext highlighter-rouge">open</code> calls (even for
the same file), don’t share the lock acquisition;</li>
</ul>

<p>This means that with BSD locks, threads or processes can’t be synchronized on
the same or duplicated file descriptor, but nevertheless, both can be
synchronized on independent file descriptors.</p>

<p><code class="language-plaintext highlighter-rouge">flock()</code> doesn’t guarantee atomic mode switch. From the man page:</p>

<blockquote>
  <p>Converting a lock (shared to exclusive, or vice versa) is not guaranteed to be
atomic: the existing lock is first removed, and then a new lock is
established. Between these two steps, a pending lock request by another
process may be granted, with the result that the conversion either blocks, or
fails if LOCK_NB was specified. (This is the original BSD behaviour, and
occurs on many other implementations.)</p>
</blockquote>

<p>This problem is solved by POSIX record locks and Open file description locks.</p>

<p>Usage example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre>#include &lt;sys/file.h&gt;

// acquire shared lock
if (flock(fd, LOCK_SH) == -1) {
    exit(1);
}

// non-atomically upgrade to exclusive lock
// do it in non-blocking mode, i.e. fail if can't upgrade immediately
if (flock(fd, LOCK_EX | LOCK_NB) == -1) {
    exit(1);
}

// release lock
// lock is also released automatically when close() is called or process exits
if (flock(fd, LOCK_UN) == -1) {
    exit(1);
}
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="posix-record-locks-fcntl"><a href="https://gavv.net/articles/file-locks/#posix-record-locks-fcntl"></a>POSIX record locks (fcntl)</h3>

<p>POSIX record locks, also known as process-associated locks, are provided by
<a href="http://man7.org/linux/man-pages/man2/fcntl.2.html"><code class="language-plaintext highlighter-rouge">fcntl(2)</code></a>, see “Advisory
record locking” section in the man page.</p>

<p>Features:</p>

<ul>
  <li><a href="https://pubs.opengroup.org/onlinepubs/9699919799/functions/fcntl.html">specified</a>
in POSIX (base standard)</li>
  <li>can be applied to a byte range</li>
  <li>associated with an <code class="language-plaintext highlighter-rouge">[i-node, pid]</code> pair instead of a file object</li>
  <li>guarantee atomic switch between the locking modes (exclusive and shared)</li>
  <li>work on NFS (on Linux)</li>
</ul>

<p>The lock acquisition is associated with an <code class="language-plaintext highlighter-rouge">[i-node, pid]</code> pair, i.e.:</p>

<ul>
  <li>file descriptors opened by the same process for the same file share the lock
acquisition (even independent file descriptors, e.g. created using two <code class="language-plaintext highlighter-rouge">open</code>
calls);</li>
  <li>file descriptors opened by different processes don’t share the lock
acquisition;</li>
</ul>

<p>This means that with POSIX record locks, it is possible to synchronize
processes, but not threads. All threads belonging to the same process always
share the lock acquisition of a file, which means that:</p>

<ul>
  <li>the lock acquired through some file descriptor by some thread may be released
through another file descriptor by another thread;</li>
  <li>when any thread calls <code class="language-plaintext highlighter-rouge">close</code> on any descriptor referring to given file, the
lock is released for the whole process, even if there are other opened
descriptors referring to this file.</li>
</ul>

<p>This problem is solved by Open file description locks.</p>

<p>Usage example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre></td><td class="rouge-code"><pre>#include &lt;fcntl.h&gt;

struct flock fl;
memset(&amp;fl, 0, sizeof(fl));

// lock in shared mode
fl.l_type = F_RDLCK;

// lock entire file
fl.l_whence = SEEK_SET; // offset base is start of the file
fl.l_start = 0;         // starting offset is zero
fl.l_len = 0;           // len is zero, which is a special value representing end
                        // of file (no matter how large the file grows in future)

fl.l_pid = 0; // F_SETLK(W) ignores it; F_OFD_SETLK(W) requires it to be zero

// F_SETLKW specifies blocking mode
if (fcntl(fd, F_SETLKW, &amp;fl) == -1) {
    exit(1);
}

// atomically upgrade shared lock to exclusive lock, but only
// for bytes in range [10; 15)
//
// after this call, the process will hold three lock regions:
//  [0; 10)        - shared lock
//  [10; 15)       - exclusive lock
//  [15; SEEK_END) - shared lock
fl.l_type = F_WRLCK;
fl.l_start = 10;
fl.l_len = 5;

// F_SETLKW specifies non-blocking mode
if (fcntl(fd, F_SETLK, &amp;fl) == -1) {
    exit(1);
}

// release lock for bytes in range [10; 15)
fl.l_type = F_UNLCK;

if (fcntl(fd, F_SETLK, &amp;fl) == -1) {
    exit(1);
}

// close file and release locks for all regions
// remember that locks are released when process calls close()
// on any descriptor for a lock file
close(fd);
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="lockf-function"><a href="https://gavv.net/articles/file-locks/#lockf-function"></a>lockf function</h3>

<p><a href="http://man7.org/linux/man-pages/man3/lockf.3.html"><code class="language-plaintext highlighter-rouge">lockf(3)</code></a> function is a
simplified version of POSIX record locks.</p>

<p>Features:</p>

<ul>
  <li><a href="https://pubs.opengroup.org/onlinepubs/9699919799/functions/lockf.html">specified</a>
in POSIX (XSI)</li>
  <li>can be applied to a byte range (optionally automatically expanding when data
is appended in future)</li>
  <li>associated with an <code class="language-plaintext highlighter-rouge">[i-node, pid]</code> pair instead of a file object</li>
  <li>supports only exclusive locks</li>
  <li>works on NFS (on Linux)</li>
</ul>

<p>Since <code class="language-plaintext highlighter-rouge">lockf</code> locks are associated with an <code class="language-plaintext highlighter-rouge">[i-node, pid]</code> pair, they have the
same problems as POSIX record locks described above.</p>

<p>The interaction between <code class="language-plaintext highlighter-rouge">lockf</code> and other types of locks is not specified by
POSIX. On Linux, <code class="language-plaintext highlighter-rouge">lockf</code> is
<a href="https://github.com/lattera/glibc/blob/master/io/lockf.c">just a wrapper</a> for
POSIX record locks.</p>

<p>Usage example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre>#include &lt;unistd.h&gt;

// set current position to byte 10
if (lseek(fd, 10, SEEK_SET) == -1) {
    exit(1);
}

// acquire exclusive lock for bytes in range [10; 15)
// F_LOCK specifies blocking mode
if (lockf(fd, F_LOCK, 5) == -1) {
    exit(1);
}

// release lock for bytes in range [10; 15)
if (lockf(fd, F_ULOCK, 5) == -1) {
    exit(1);
}
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="open-file-description-locks-fcntl"><a href="https://gavv.net/articles/file-locks/#open-file-description-locks-fcntl"></a>Open file description locks (fcntl)</h3>

<p>Open file description locks are Linux-specific and combine advantages of the BSD
locks and POSIX record locks. They are provided by
<a href="http://man7.org/linux/man-pages/man2/fcntl.2.html"><code class="language-plaintext highlighter-rouge">fcntl(2)</code></a>, see “Open file
description locks (non-POSIX)” section in the man page.</p>

<p>Features:</p>

<ul>
  <li>Linux-specific, not specified in POSIX</li>
  <li>can be applied to a byte range</li>
  <li>associated with a file object</li>
  <li>guarantee atomic switch between the locking modes (exclusive and shared)</li>
  <li>work on NFS (on Linux)</li>
</ul>

<p>Thus, Open file description locks combine advantages of BSD locks and POSIX
record locks: they provide both atomic switch between the locking modes, and the
ability to synchronize both threads and processes.</p>

<p>These locks are available since the 3.15 kernel.</p>

<p>The API is the same as for POSIX record locks (see above). It uses
<code class="language-plaintext highlighter-rouge">struct flock</code> too. The only difference is in <code class="language-plaintext highlighter-rouge">fcntl</code> command names:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">F_OFD_SETLK</code> instead of <code class="language-plaintext highlighter-rouge">F_SETLK</code></li>
  <li><code class="language-plaintext highlighter-rouge">F_OFD_SETLKW</code> instead of <code class="language-plaintext highlighter-rouge">F_SETLKW</code></li>
  <li><code class="language-plaintext highlighter-rouge">F_OFD_GETLK</code> instead of <code class="language-plaintext highlighter-rouge">F_GETLK</code></li>
</ul>

<h3 id="emulating-open-file-description-locks"><a href="https://gavv.net/articles/file-locks/#emulating-open-file-description-locks"></a>Emulating Open file description locks</h3>

<p>What do we have for multithreading and atomicity so far?</p>

<ul>
  <li>BSD locks allow thread synchronization but don’t allow atomic mode switch.</li>
  <li>POSIX record locks don’t allow thread synchronization but allow atomic mode
switch.</li>
  <li>Open file description locks allow both but are available only on recent Linux
kernels.</li>
</ul>

<p>If you need both features but can’t use Open file description locks (e.g. you’re
using some embedded system with an outdated Linux kernel), you can <em>emulate</em>
them on top of the POSIX record locks.</p>

<p>Here is one possible approach:</p>

<ul>
  <li>Implement your own API for file locks. Ensure that all threads always use this
API instead of using <code class="language-plaintext highlighter-rouge">fcntl()</code> directly. Ensure that threads never open and
close lock-files directly.</li>
  <li>In the API, implement a process-wide singleton (shared by all threads) holding
all currently acquired locks.</li>
  <li>Associate two additional objects with every acquired lock:</li>
  <li>a counter</li>
  <li>an RW-mutex, e.g.
<a href="https://pubs.opengroup.org/onlinepubs/9699919799/functions/pthread_rwlock_destroy.html"><code class="language-plaintext highlighter-rouge">pthread_rwlock</code></a></li>
</ul>

<p>Now, you can implement lock operations as follows:</p>

<ul>
  <li>Acquiring lock</li>
  <li>First, acquire the RW-mutex. If the user requested the shared mode, acquire a
read lock. If the user requested the exclusive mode, acquire a write lock.</li>
  <li>Check the counter. If it’s zero, also acquire the file lock using <code class="language-plaintext highlighter-rouge">fcntl()</code>.</li>
  <li>Increment the counter.</li>
  <li>Releasing lock</li>
  <li>Decrement the counter.</li>
  <li>If the counter becomes zero, release the file lock using <code class="language-plaintext highlighter-rouge">fcntl()</code>.</li>
  <li>Release the RW-mutex.</li>
</ul>

<p>This approach makes possible both thread and process synchronization.</p>

<h3 id="test-program"><a href="https://gavv.net/articles/file-locks/#test-program"></a>Test program</h3>

<p>I’ve prepared a
<a href="https://github.com/gavv/snippets/blob/master/fs/locks.c">small program</a> that
helps to learn the behavior of different lock types.</p>

<p>The program starts two threads or processes, both of which wait to acquire the
lock, then sleep for one second, and then release the lock. It has three
parameters:</p>

<ul>
  <li>lock mode: <code class="language-plaintext highlighter-rouge">flock</code> (BSD locks), <code class="language-plaintext highlighter-rouge">lockf</code>, <code class="language-plaintext highlighter-rouge">fcntl_posix</code> (POSIX record locks),
<code class="language-plaintext highlighter-rouge">fcntl_linux</code> (Open file description locks)</li>
  <li>access mode: <code class="language-plaintext highlighter-rouge">same_fd</code> (access lock via the same descriptor), <code class="language-plaintext highlighter-rouge">dup_fd</code> (access
lock via duplicated descriptors), <code class="language-plaintext highlighter-rouge">two_fds</code> (access lock via two descriptors
opened independently for the same path)</li>
  <li>concurrency mode: <code class="language-plaintext highlighter-rouge">threads</code> (access lock from two threads), <code class="language-plaintext highlighter-rouge">processes</code>
(access lock from two processes)</li>
</ul>

<p>Below you can find some examples.</p>

<p>Threads are not serialized if they use BSD locks on duplicated descriptors:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>$ ./a.out flock dup_fd threads
13:00:58 pid=5790 tid=5790 lock
13:00:58 pid=5790 tid=5791 lock
13:00:58 pid=5790 tid=5790 sleep
13:00:58 pid=5790 tid=5791 sleep
13:00:59 pid=5790 tid=5791 unlock
13:00:59 pid=5790 tid=5790 unlock
</pre></td></tr></tbody></table></code></pre></div></div>

<p>But they are serialized if they are used on two independent descriptors:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>$ ./a.out flock two_fds threads
13:01:03 pid=5792 tid=5792 lock
13:01:03 pid=5792 tid=5794 lock
13:01:03 pid=5792 tid=5792 sleep
13:01:04 pid=5792 tid=5792 unlock
13:01:04 pid=5792 tid=5794 sleep
13:01:05 pid=5792 tid=5794 unlock
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Threads are not serialized if they use POSIX record locks on two independent
descriptors:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>$ ./a.out fcntl_posix two_fds threads
13:01:08 pid=5795 tid=5795 lock
13:01:08 pid=5795 tid=5796 lock
13:01:08 pid=5795 tid=5795 sleep
13:01:08 pid=5795 tid=5796 sleep
13:01:09 pid=5795 tid=5795 unlock
13:01:09 pid=5795 tid=5796 unlock
</pre></td></tr></tbody></table></code></pre></div></div>

<p>But processes are serialized:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>$ ./a.out fcntl_posix two_fds processes
13:01:13 pid=5797 tid=5797 lock
13:01:13 pid=5798 tid=5798 lock
13:01:13 pid=5797 tid=5797 sleep
13:01:14 pid=5797 tid=5797 unlock
13:01:14 pid=5798 tid=5798 sleep
13:01:15 pid=5798 tid=5798 unlock
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="command-line-tools"><a href="https://gavv.net/articles/file-locks/#command-line-tools"></a>Command-line tools</h3>

<p>The following tools may be used to acquire and release file locks from the
command line:</p>

<ul>
  <li>
    <p><a href="http://man7.org/linux/man-pages/man1/flock.1.html"><strong><code class="language-plaintext highlighter-rouge">flock</code></strong></a></p>

    <p>Provided by <code class="language-plaintext highlighter-rouge">util-linux</code> package. Uses <code class="language-plaintext highlighter-rouge">flock()</code> function.</p>

    <p>There are two ways to use this tool:</p>

    <ul>
      <li>
        <p>run a command while holding a lock:</p>

        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>flock my.lock sleep 10
</pre></td></tr></tbody></table></code></pre></div>        </div>

        <p><code class="language-plaintext highlighter-rouge">flock</code> will acquire the lock, run the command, and release the lock.</p>
      </li>
      <li>
        <p>open a file descriptor in bash and use <code class="language-plaintext highlighter-rouge">flock</code> to acquire and release the
lock manually:</p>

        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>set -e            # die on errors
exec 100&gt;my.lock  # open file 'my.lock' and link file descriptor 100 to it
flock -n 100      # acquire a lock
echo hello
sleep 10
echo goodbye
flock -u -n 100   # release the lock
</pre></td></tr></tbody></table></code></pre></div>        </div>
      </li>
    </ul>

    <p>You can try to run these two snippets in parallel in different terminals and
see that while one is sleeping while holding the lock, another is blocked in
flock.</p>
  </li>
  <li>
    <p><a href="https://linux.die.net/man/1/lockfile"><strong><code class="language-plaintext highlighter-rouge">lockfile</code></strong></a></p>

    <p>Provided by <code class="language-plaintext highlighter-rouge">procmail</code> package.</p>

    <p>Runs the given command while holding a lock. Can use either <code class="language-plaintext highlighter-rouge">flock()</code>,
<code class="language-plaintext highlighter-rouge">lockf()</code>, or <code class="language-plaintext highlighter-rouge">fcntl()</code> function, depending on what’s available on the system.</p>
  </li>
</ul>

<p>There are also two ways to inspect the currently acquired locks:</p>

<ul>
  <li>
    <p><a href="http://man7.org/linux/man-pages/man8/lslocks.8.html"><strong><code class="language-plaintext highlighter-rouge">lslocks</code></strong></a></p>

    <p>Provided by <code class="language-plaintext highlighter-rouge">util-linux</code> package.</p>

    <p>Lists all the currently held file locks in the entire system. Allows to
perform filtering by PID and to configure the output format.</p>

    <p>Example output:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>COMMAND           PID   TYPE   SIZE MODE  M      START        END PATH
containerd       4498  FLOCK   256K WRITE 0          0          0 /var/lib/docker/containerd/...
dockerd          4289  FLOCK   256K WRITE 0          0          0 /var/lib/docker/volumes/...
(undefined)        -1 OFDLCK        READ  0          0          0 /dev...
dockerd          4289  FLOCK    16K WRITE 0          0          0 /var/lib/docker/builder/...
dockerd          4289  FLOCK    16K WRITE 0          0          0 /var/lib/docker/buildkit/...
dockerd          4289  FLOCK    16K WRITE 0          0          0 /var/lib/docker/buildkit/...
dockerd          4289  FLOCK    32K WRITE 0          0          0 /var/lib/docker/buildkit/...
(unknown)        4417  FLOCK        WRITE 0          0          0 /run...
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>
    <p><a href="http://man7.org/linux/man-pages/man5/proc.5.html"><strong><code class="language-plaintext highlighter-rouge">/proc/locks</code></strong></a></p>

    <p>A file in <code class="language-plaintext highlighter-rouge">procfs</code> virtual file system that shows current file locks of all
types. The <code class="language-plaintext highlighter-rouge">lslocks</code> tools relies on this file.</p>

    <p>Example content:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>16: FLOCK  ADVISORY  WRITE 4417 00:17:23319 0 EOF
27: FLOCK  ADVISORY  WRITE 4289 08:03:9441686 0 EOF
28: FLOCK  ADVISORY  WRITE 4289 08:03:9441684 0 EOF
29: FLOCK  ADVISORY  WRITE 4289 08:03:9441681 0 EOF
30: FLOCK  ADVISORY  WRITE 4289 08:03:8528339 0 EOF
31: OFDLCK ADVISORY  READ  -1 00:06:9218 0 EOF
43: FLOCK  ADVISORY  WRITE 4289 08:03:8536567 0 EOF
52: FLOCK  ADVISORY  WRITE 4498 08:03:8520185 0 EOF
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
</ul>

<hr />

<h2 id="mandatory-locking"><a href="https://gavv.net/articles/file-locks/#mandatory-locking"></a>Mandatory locking</h2>

<p>Linux has limited support for
<a href="https://www.kernel.org/doc/Documentation/filesystems/mandatory-locking.txt">mandatory file locking</a>.
See the “Mandatory locking” section in the
<a href="http://man7.org/linux/man-pages/man2/fcntl.2.html"><code class="language-plaintext highlighter-rouge">fcntl(2)</code></a> man page.</p>

<p>A mandatory lock is activated for a file when all of these conditions are met:</p>

<ul>
  <li>The partition was mounted with the <code class="language-plaintext highlighter-rouge">mand</code> option.</li>
  <li>The set-group-ID bit is on and group-execute bit is off for the file.</li>
  <li>A POSIX record lock is acquired.</li>
</ul>

<p>Note that the <a href="https://en.wikipedia.org/wiki/Setuid">set-group-ID</a> bit has its
regular meaning of elevating privileges when the group-execute bit is on and a
special meaning of enabling mandatory locking when the group-execute bit is off.</p>

<p>When a mandatory lock is activated, it affects regular system calls on the file:</p>

<ul>
  <li>When an exclusive or shared lock is acquired, all system calls that <em>modify</em>
the file (e.g. <code class="language-plaintext highlighter-rouge">open()</code> and <code class="language-plaintext highlighter-rouge">truncate()</code>) are blocked until the lock is
released.</li>
  <li>When an exclusive lock is acquired, all system calls that <em>read</em> from the file
(e.g. <code class="language-plaintext highlighter-rouge">read()</code>) are blocked until the lock is released.</li>
</ul>

<p>However, the documentation mentions that current implementation is not reliable,
in particular:</p>

<ul>
  <li>races are possible when locks are acquired concurrently with <code class="language-plaintext highlighter-rouge">read()</code> or
<code class="language-plaintext highlighter-rouge">write()</code></li>
  <li>races are possible when using <code class="language-plaintext highlighter-rouge">mmap()</code></li>
</ul>

<p>Since mandatory locks are not allowed for directories and are ignored by
<code class="language-plaintext highlighter-rouge">unlink()</code> and <code class="language-plaintext highlighter-rouge">rename()</code> calls, you can’t prevent file deletion or renaming
using these locks.</p>

<h3 id="example-usage"><a href="https://gavv.net/articles/file-locks/#example-usage"></a>Example usage</h3>

<p>Below you can find a usage example of mandatory locking.</p>

<p><code class="language-plaintext highlighter-rouge">fcntl_lock.c</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre>#include &lt;sys/fcntl.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;

int main(int argc, char **argv) {
    if (argc != 2) {
        fprintf(stderr, "usage: %s file\n", argv[0]);
        exit(1);
    }

    int fd = open(argv[1], O_RDWR);
    if (fd == -1) {
        perror("open");
        exit(1);
    }

    struct flock fl = {};
    fl.l_type = F_WRLCK;
    fl.l_whence = SEEK_SET;
    fl.l_start = 0;
    fl.l_len = 0;

    if (fcntl(fd, F_SETLKW, &amp;fl) == -1) {
        perror("fcntl");
        exit(1);
    }

    pause();
    exit(0);
}
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Build <code class="language-plaintext highlighter-rouge">fcntl_lock</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>$ gcc -o fcntl_lock fcntl_lock.c
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Mount the partition and create a file with the mandatory locking enabled:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>$ mkdir dir
$ mount -t tmpfs -o mand,size=1m tmpfs ./dir
$ echo hello &gt; dir/lockfile
$ chmod g+s,g-x dir/lockfile
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Acquire a lock in the first terminal:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>$ ./fcntl_lock dir/lockfile
(wait for a while)
^C
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Try to read the file in the second terminal:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>$ cat dir/lockfile
(hangs until ^C is pressed in the first terminal)
hello
</pre></td></tr></tbody></table></code></pre></div></div>


        <!-- Post Pager -->
        <div>
          <hr style="visibility: hidden" />
          <ul class="pager"><li class="previous">
              <a
                href="/pages/manifoldfinance/primitives/questions-for-new-tech"
                data-toggle="tooltip"
                data-placement="top"
                title="Questions For New Tech"
              >
                Previous<br />
                <span>Questions For New Tech</span>
              </a>
            </li><li class="next">
              <a
                href="/pages/manifoldfinance/primitives/differential-dataflow-pt1"
                data-toggle="tooltip"
                data-placement="top"
                title="Differential Dataflow Pt1"
              >
                Next<br />
                <span>Differential Dataflow Pt1</span>
              </a>
            </li></ul>
          <hr style="visibility: hidden" />
        </div></div><!-- Side Catalog Container -->
      <div
        class="col-lg-2 col-lg-offset-0 visible-lg-block sidebar-container catalog-container"
      >
        <div class="side-catalog">
          <hr class="hidden-sm hidden-xs" />
          <h5>
            <a class="catalog-toggle" href="#">CATALOG</a>
          </h5>
          <ul class="catalog-body"></ul>
        </div>
      </div><!-- Sidebar Container -->
      <div
        class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 sidebar-container"
      ><!-- Featured Tags -->
<section><hr class="hidden-sm hidden-xs"><h5>
        <a href="/pages/manifoldfinance/primitives/archive/">FEATURED TAGS</a>
    </h5>
    <div class="tags"><a data-sort="0014"
            href="/pages/manifoldfinance/primitives/archive/?tag=distributed+computing"
            title="distributed computing"
            rel="3">distributed computing</a><a data-sort="0014"
            href="/pages/manifoldfinance/primitives/archive/?tag=ethereum"
            title="ethereum"
            rel="3">ethereum</a><a data-sort="0015"
            href="/pages/manifoldfinance/primitives/archive/?tag=blockchain"
            title="blockchain"
            rel="2">blockchain</a><a data-sort="0016"
            href="/pages/manifoldfinance/primitives/archive/?tag=DAO"
            title="DAO"
            rel="1">DAO</a><a data-sort="0016"
            href="/pages/manifoldfinance/primitives/archive/?tag=Jekyll"
            title="Jekyll"
            rel="1">Jekyll</a><a data-sort="0016"
            href="/pages/manifoldfinance/primitives/archive/?tag=Markdown"
            title="Markdown"
            rel="1">Markdown</a><a data-sort="0016"
            href="/pages/manifoldfinance/primitives/archive/?tag=amm"
            title="amm"
            rel="1">amm</a><a data-sort="0016"
            href="/pages/manifoldfinance/primitives/archive/?tag=analysis"
            title="analysis"
            rel="1">analysis</a><a data-sort="0016"
            href="/pages/manifoldfinance/primitives/archive/?tag=client+development"
            title="client development"
            rel="1">client development</a><a data-sort="0016"
            href="/pages/manifoldfinance/primitives/archive/?tag=dao"
            title="dao"
            rel="1">dao</a><a data-sort="0016"
            href="/pages/manifoldfinance/primitives/archive/?tag=devops"
            title="devops"
            rel="1">devops</a><a data-sort="0016"
            href="/pages/manifoldfinance/primitives/archive/?tag=gitops"
            title="gitops"
            rel="1">gitops</a><a data-sort="0016"
            href="/pages/manifoldfinance/primitives/archive/?tag=governance"
            title="governance"
            rel="1">governance</a><a data-sort="0016"
            href="/pages/manifoldfinance/primitives/archive/?tag=json+rpc"
            title="json rpc"
            rel="1">json rpc</a><a data-sort="0016"
            href="/pages/manifoldfinance/primitives/archive/?tag=nix"
            title="nix"
            rel="1">nix</a><a data-sort="0016"
            href="/pages/manifoldfinance/primitives/archive/?tag=protocol"
            title="protocol"
            rel="1">protocol</a><a data-sort="0016"
            href="/pages/manifoldfinance/primitives/archive/?tag=routing"
            title="routing"
            rel="1">routing</a><a data-sort="0016"
            href="/pages/manifoldfinance/primitives/archive/?tag=sushiswap"
            title="sushiswap"
            rel="1">sushiswap</a><a data-sort="0016"
            href="/pages/manifoldfinance/primitives/archive/?tag=tooling"
            title="tooling"
            rel="1">tooling</a><a data-sort="0016"
            href="/pages/manifoldfinance/primitives/archive/?tag=trading"
            title="trading"
            rel="1">trading</a>
    </div>
</section>
</div>
    </div>
  </div>
</article>
<!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><!-- SNS -->
<ul class="list-inline text-center">
  
  <li>
    <a href="/pages/manifoldfinance/primitives/feed.xml">
      <span class="fa-stack fa-lg">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  </li><li>
    <a target="_blank" href="mailto:sam@manifoldfinance.com">
      <span class="fa-stack fa-lg">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  </li><li>
    <a target="_blank" href="https://github.com/manifoldfinance">
      <span class="fa-stack fa-lg">
        <i class="fas fa-circle fa-stack-2x fa-inverse"></i>
        <i class="fab fa-github fa-stack-2x"></i>
      </span>
    </a>
  </li><li>
    <a href="https://twitter.com/foldfinance">
      <span class="fa-stack fa-lg">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  </li></ul>
<p class="copyright text-muted">See
          <a href="https://github.com/sambacha"></a> @sambacha | &copy; 2022-2024 manifoldfinance
        </p>
      </div>
    </div>
  </div>
</footer>

<!-- jQuery -->
<script
  src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"
  integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg=="
  crossorigin="anonymous"
></script>

<!-- Bootstrap JavaScript-->
<!-- Currently, only navbar scroll-down effect at desktop still depends on this -->
<script
  src="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"
  integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd"
  crossorigin="anonymous"
></script>

<!-- Simple Jekyll Search -->
<script
  src="https://cdnjs.cloudflare.com/ajax/libs/simple-jekyll-search/1.7.12/simple-jekyll-search.min.js"
  integrity="sha512-APy7Ff/y4pdIHleqiTMcRZ8Wu6tjfqhJpgAcaCvTuFQPj/G+/A5u0uZi/DkfkuLQ6FeFmDJgh/zl0y3If/VUyA=="
  crossorigin="anonymous"
></script>

<!-- MathJax https://github.com/mathjax/MathJax/issues/2220 -->
<script>
  MathJax = {
    options: {
      renderActions: {
        /* add a new named action not to override the original 'find' action */
        find_script_mathtex: [
          10,
          function (doc) {
            for (const node of document.querySelectorAll(
              'script[type^="math/tex"]',
            )) {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(
                node.textContent,
                doc.inputJax[0],
                display,
              );
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = { node: text, delim: '', n: 0 };
              math.end = { node: text, delim: '', n: 0 };
              doc.math.push(math);
            }
          },
          '',
        ],
      },
    },
  };
</script>
<script
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.0.5/es5/tex-chtml.js"
  integrity="sha512-WIPUeuVusAT6dUtN6xKArYCBEa76ltyvaz3ltvQd+dy7ISdGJv1Y3y7eDBEF986YfNtmZGLdAaEBSgeBb+8OSg=="
  crossorigin="anonymous"
></script>

<!-- Async load function -->
<script>
  function async(u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener(
        'load',
        function (e) {
          c(null, e);
        },
        false,
      );
    }
    s.parentNode.insertBefore(o, s);
  }
</script><!-- AnchorJS -->
<script>
  async(
    'https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.2/anchor.min.js',
    function () {
      anchors.options = {
        visible: 'hover',
      };
      anchors
        .add()
        .remove('.intro-header h1')
        .remove('.subheading')
        .remove('.sidebar-container h5');
    },
  );
</script><!-- Custom JavaScript -->
<script src="/pages/manifoldfinance/primitives/assets/js/main.js"></script><!-- Side Catalog -->
<script src="/pages/manifoldfinance/primitives/assets/js/catalog.js"></script></body>
</html>
